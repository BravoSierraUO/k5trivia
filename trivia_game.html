<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trivia Game</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            background: linear-gradient(to bottom, #d4a8e1, #a8d4e1); /* Soft purple to soft blue gradient */
            color: #ffffff; 
            margin: 20px; 
            display: flex; 
            font-size: 22px; 
            height: calc(100vh - 40px); 
            box-sizing: border-box; 
        }
        #sidebar { 
            width: 300px; 
            background: rgba(26, 26, 26, 0.8); /* Slightly opaque black background */
            padding: 25px; 
            box-shadow: 2px 0 5px rgba(0,0,0,0.5); 
            box-sizing: border-box; 
            font-size: 18px; 
            display: flex;
            flex-direction: column;
            border-radius: 10px;
        }
        #game-container { 
            flex: 1; 
            padding: 25px; 
            transition: all 0.3s; 
            box-sizing: border-box; 
        }
        #game-container.fullscreen { 
            margin: 0; 
            padding: 25px; 
            width: calc(100vw - 40px); 
            height: calc(100vh - 40px); 
        }
        #selection-container { 
            flex: 1;
            display: flex;
        }
        #selection-content { 
            background: rgba(26, 26, 26, 0.8); /* Slightly opaque black background */
            padding: 25px; 
            border-radius: 10px; 
            box-shadow: 0 0 10px rgba(0,0,0,0.5); 
            height: 100%; 
            box-sizing: border-box; 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            width: 100%;
        }
        #question-container { 
            background: rgba(26, 26, 26, 0.8); /* Slightly opaque black background */
            padding: 25px; 
            border-radius: 10px; 
            box-shadow: 0 0 10px rgba(0,0,0,0.5); 
            height: 100%; 
            box-sizing: border-box; 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
        }
        #subcategory-header { 
            font-size: 24px; 
            margin-bottom: 20px; 
            text-align: center; 
        }
        #question-text { 
            font-size: 24px; 
            margin-bottom: 20px; 
            text-align: center; 
        }
        #answers-container { 
            display: grid; 
            grid-template-columns: repeat(2, 1fr); 
            gap: 15px; 
            margin-bottom: 20px; 
        }
        #result-text { 
            font-size: 28px; 
            text-align: center; 
            margin-top: 20px; 
        }
        #play-again-btn { 
            margin: 20px auto 0; 
            text-align: center; 
            display: none; 
        }
        .answer-btn { 
            padding: 20px; 
            background: #007BFF; 
            color: white; 
            border: none; 
            border-radius: 5px; 
            cursor: pointer; 
            font-size: 22px; 
        }
        .answer-btn:hover { background: #0056b3; }
        #start-game-btn, #play-again-btn, #reset-btn, #logout-btn, #settings-btn, #save-changes-btn { 
            padding: 20px 30px; 
            background: #28a745; 
            color: white; 
            border: none; 
            border-radius: 5px; 
            cursor: pointer; 
            font-size: 18px; 
        }
        #start-game-btn:disabled, #play-again-btn:disabled { 
            background: #6c757d; 
            cursor: not-allowed; 
        }
        #reset-btn { background: #dc3545; }
        #reset-btn:hover { background: #c82333; }
        #logout-btn { background: #6c757d; }
        #logout-btn:hover { background: #5a6268; }
        #settings-btn { background: #007BFF; }
        #settings-btn:hover { background: #0056b3; }
        #save-changes-btn { background: #28a745; }
        #save-changes-btn:hover { background: #218838; }
        .selection-group { margin: 20px 0; }
        .selection-group label { display: block; margin-bottom: 15px; font-size: 24px; }
        .selection-button { 
            margin: 8px; 
            padding: 15px 20px; 
            background: #333333; 
            color: #ffffff; 
            border: 1px solid #555555; 
            border-radius: 5px; 
            cursor: pointer; 
            font-size: 22px; 
        }
        .selection-button.selected { 
            background: #007BFF; 
            border-color: #007BFF; 
            box-shadow: 0 0 5px rgba(0, 123, 255, 0.5); 
        }
        .selection-button:disabled { 
            background: #6c757d; 
            cursor: not-allowed; 
        }
        .xp-bar { margin: 20px 0; }
        .xp-bar label { display: block; font-size: 16px; }
        .xp-bar progress { width: 100%; height: 30px; }
        .category-header { 
            cursor: pointer; 
            font-weight: bold; 
            font-size: 20px; 
            display: flex; 
            align-items: center; 
        }
        .category-header::before { 
            content: '▶'; 
            margin-right: 10px; 
        }
        .category-header.collapsed::before { 
            content: '▼'; 
        }
        .subcategory-list { 
            display: none; 
            margin-left: 20px; 
        }
        .subcategory-list.visible { 
            display: block; 
        }
        #delay-setting { margin: 25px 0; }
        #delay-setting label { display: block; margin-bottom: 15px; font-size: 18px; }
        #delay-setting input { 
            width: 140px; 
            margin-bottom: 20px; 
            background: #333333; 
            color: #ffffff; 
            border: 1px solid #555555; 
            font-size: 18px; 
            padding: 8px; 
        }
        #version-display { 
            position: fixed; 
            bottom: 30px; 
            right: 30px; 
            color: #ffffff; 
            font-size: 20px; 
        }
        #xp-bars-container {
            flex: 1; 
            overflow-y: auto;
            margin-bottom: 20px;
        }
        #settings-content {
            display: none;
            padding: 25px;
            background: rgba(26, 26, 26, 0.8); /* Slightly opaque black background */
            border-radius: 10px;
            box-shadow: 0 0 10px rgba(0,0,0,0.5);
            height: 100%;
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .checkbox-setting { margin: 20px 0; }
        .checkbox-setting label { font-size: 18px; margin-left: 10px; }
    </style>
</head>
<body>
    <div id="sidebar">
        <h3>Stats & Settings</h3>
        <div class="xp-bar">
            <label>Total XP: <span id="total-xp">0</span></label>
            <progress id="total-xp-bar" max="1000" value="0"></progress>
        </div>
        <div id="xp-bars-container">
            <div id="category-xp-bars"></div>
        </div>
        <button id="settings-btn">Settings</button>
        <button id="logout-btn">Logout</button>
    </div>
    <div id="game-container">
        <div id="selection-container">
            <div id="selection-content">
                <div class="selection-group">
                    <label>Select Category:</label>
                    <div id="category-buttons"></div>
                </div>
                <div class="selection-group" id="subcategory-group" style="display: none;">
                    <label>Select Subcategory:</label>
                    <div id="subcategory-buttons"></div>
                </div>
                <div class="selection-group" id="level-group" style="display: none;">
                    <label>Select Level:</label>
                    <div id="level-buttons"></div>
                </div>
                <div class="selection-group">
                    <label>Select Number of Questions:</label>
                    <div id="num-questions-buttons">
                        <button class="selection-button" data-num-questions="5">5</button>
                        <button class="selection-button" data-num-questions="10">10</button>
                        <button class="selection-button" data-num-questions="15">15</button>
                        <button class="selection-button" data-num-questions="20">20</button>
                    </div>
                </div>
                <button id="start-game-btn" disabled>Start Game</button>
            </div>
        </div>
        <div id="question-container" style="display: none;">
            <h2 id="subcategory-header"></h2>
            <h2 id="question-text"></h2>
            <div id="answers-container"></div>
            <p id="result-text"></p>
            <button id="play-again-btn" style="display: none;">Back to Main</button>
        </div>
        <div id="settings-content" style="display: none;">
            <div id="delay-setting">
                <label for="correct-delay">Time to Display "Correct" (ms):</label>
                <input type="number" id="correct-delay" min="0" max="5000" step="100" value="500">
                <label for="explanation-delay">Time to Display Explanation (ms):</label>
                <input type="number" id="explanation-delay" min="0" max="5000" step="100" value="1000">
            </div>
            <div class="checkbox-setting">
                <input type="checkbox" id="show-question-id" name="show-question-id">
                <label for="show-question-id">Show Question ID</label>
            </div>
            <button id="reset-btn">Reset Data</button>
            <button id="save-changes-btn">Save Changes</button>
        </div>
    </div>
    <div id="version-display">Version 1.2.030</div>

    <script>
        // Check for logged-in user
        const settings = JSON.parse(localStorage.getItem('triviaSettings')) || { correctDelay: 500, explanationDelay: 1000, showQuestionId: false, loggedIn: '' };
        if (!settings || !settings.loggedIn) {
            window.location.href = './index.html';
        }

        let categories = [];
        let subcategories = {};
        let categoryFiles = {}; // To store file mappings
        let currentQuestion = null;
        let userXP = parseInt(localStorage.getItem('triviaUserXP')) || 0;
        let categoryXPAmt = JSON.parse(localStorage.getItem('triviaCategoryXP')) || {};
        let selectedNumQuestions = 0;
        let questionsAnswered = 0;
        let selectedLevel = null;
        let gameLevel = null;
        let selectedCategory = null;
        let selectedSubcategories = [];
        let usedQuestionIds = new Set();
        const startGameButton = document.getElementById('start-game-btn');
        const questionContainer = document.getElementById('question-container');
        const selectionContainer = document.getElementById('selection-container');
        const questionText = document.getElementById('question-text');
        const answersContainer = document.getElementById('answers-container');
        const resultText = document.getElementById('result-text');
        const playAgainButton = document.getElementById('play-again-btn');
        const categoryButtons = document.getElementById('category-buttons');
        const subcategoryButtons = document.getElementById('subcategory-buttons');
        const levelButtons = document.getElementById('level-buttons');
        const numQuestionsButtons = document.getElementById('num-questions-buttons');
        const subcategoryGroup = document.getElementById('subcategory-group');
        const levelGroup = document.getElementById('level-group');
        const totalXP = document.getElementById('total-xp');
        const totalXPBar = document.getElementById('total-xp-bar');
        const categoryXPBars = document.getElementById('category-xp-bars');
        const resetButton = document.getElementById('reset-btn');
        const logoutButton = document.getElementById('logout-btn');
        const settingsButton = document.getElementById('settings-btn');
        const saveChangesButton = document.getElementById('save-changes-btn');
        const correctDelayInput = document.getElementById('correct-delay');
        const explanationDelayInput = document.getElementById('explanation-delay');
        const showQuestionIdCheckbox = document.getElementById('show-question-id');
        const sidebar = document.getElementById('sidebar');
        const gameContainer = document.getElementById('game-container');
        const subcategoryHeader = document.getElementById('subcategory-header');
        const settingsContent = document.getElementById('settings-content');

        // Initialize settings with defaults
        correctDelayInput.value = settings.correctDelay || 500;
        explanationDelayInput.value = settings.explanationDelay || 1000;
        showQuestionIdCheckbox.checked = settings.showQuestionId || false;

        // Settings button toggle
        settingsButton.addEventListener('click', () => {
            selectionContainer.style.display = 'none';
            settingsContent.style.display = 'block';
        });

        // Save changes and return to category view
        saveChangesButton.addEventListener('click', () => {
            settings.correctDelay = parseInt(correctDelayInput.value) || 500;
            settings.explanationDelay = parseInt(explanationDelayInput.value) || 1000;
            settings.showQuestionId = showQuestionIdCheckbox.checked;
            localStorage.setItem('triviaSettings', JSON.stringify(settings));
            settingsContent.style.display = 'none';
            selectionContainer.style.display = 'block';
        });

        // Load categories
        fetch('./category.json?_=' + Date.now())
            .then(response => {
                if (!response.ok) throw new Error('Network response was not ok');
                return response.json();
            })
            .then(categoryData => {
                categories = categoryData.map(cat => cat.category);
                subcategories = categoryData.reduce((acc, cat) => {
                    acc[cat.category] = cat.subcategory;
                    return acc;
                }, {});
                categoryFiles = categoryData.reduce((acc, cat) => {
                    acc[cat.category] = cat.file;
                    return acc;
                }, {});

                // Initialize categoryXPAmt for new categories/subcategories
                categories.forEach(cat => {
                    if (!categoryXPAmt[cat]) categoryXPAmt[cat] = {};
                    subcategories[cat].forEach(sub => {
                        if (!categoryXPAmt[cat][sub]) categoryXPAmt[cat][sub] = 0;
                    });
                });

                // Clean categoryXPAmt
                cleanCategoryXPAmt();

                // Populate category buttons
                populateCategoryButtons();
            })
            .catch(error => {
                console.error('Error loading categories:', error);
                // Set default category and subcategory
                categories = ['unknown'];
                subcategories = { 'unknown': ['subunknown'] };
                categoryFiles = { 'unknown': 'unknown.json' };
                
                // Initialize categoryXPAmt for default category/subcategory
                if (!categoryXPAmt['unknown']) categoryXPAmt['unknown'] = {};
                if (!categoryXPAmt['unknown']['subunknown']) categoryXPAmt['unknown']['subunknown'] = 0;
                
                // Clean categoryXPAmt
                cleanCategoryXPAmt();

                // Populate category buttons
                populateCategoryButtons();

                startGameButton.disabled = false;
                console.log('Default categories loaded:', categories);
                console.log('Default subcategories:', subcategories);
                console.log('Default category files:', categoryFiles);
                updateXPBars();
            });

        // Function to populate category buttons
        function populateCategoryButtons() {
            categoryButtons.innerHTML = '';
            categories.forEach(cat => {
                const button = document.createElement('button');
                button.className = 'selection-button';
                button.setAttribute('data-category', cat);
                button.textContent = cat;
                button.addEventListener('click', () => {
                    selectedCategory = cat;
                    selectedSubcategories = [];
                    categoryButtons.querySelectorAll('.selection-button').forEach(btn => btn.classList.remove('selected'));
                    button.classList.add('selected');
                    updateSubcategoryButtons();
                    updateLevelButtons();
                    updateStartButtonState();
                });
                categoryButtons.appendChild(button);
            });
            startGameButton.disabled = false;
            updateXPBars();
        }

        // Validate and clean categoryXPAmt, and sync userXP
        function cleanCategoryXPAmt() {
            let totalXP = 0;
            for (const category in categoryXPAmt) {
                if (!categories.includes(category)) {
                    delete categoryXPAmt[category];
                    continue;
                }
                for (const sub in categoryXPAmt[category]) {
                    if (!subcategories[category] || !subcategories[category].includes(sub)) {
                        delete categoryXPAmt[category][sub];
                    } else {
                        totalXP += categoryXPAmt[category][sub];
                    }
                }
            }
            userXP = totalXP;
            localStorage.setItem('triviaUserXP', userXP);
            localStorage.setItem('triviaCategoryXP', JSON.stringify(categoryXPAmt));
        }

        // Subcategory button handlers
        function updateSubcategoryButtons() {
            subcategoryButtons.innerHTML = '';
            subcategoryGroup.style.display = 'none';
            selectedSubcategories = [];
            if (selectedCategory) {
                const subs = subcategories[selectedCategory];
                if (subs.length > 1 || (subs.length === 1 && subs[0] !== 'null')) {
                    subcategoryGroup.style.display = 'block';
                    subs.forEach(sub => {
                        const button = document.createElement('button');
                        button.className = 'selection-button';
                        button.setAttribute('data-subcategory', sub);
                        button.textContent = sub === 'null' ? 'General' : sub;
                        button.addEventListener('click', () => {
                            if (selectedSubcategories.includes(sub)) {
                                selectedSubcategories = selectedSubcategories.filter(s => s !== sub);
                                button.classList.remove('selected');
                            } else {
                                selectedSubcategories.push(sub);
                                button.classList.add('selected');
                            }
                            updateLevelButtons();
                            updateStartButtonState();
                        });
                        subcategoryButtons.appendChild(button);
                    });
                    // Add "All" option
                    const allButton = document.createElement('button');
                    allButton.className = 'selection-button';
                    allButton.setAttribute('data-subcategory', 'All');
                    allButton.textContent = 'All';
                    allButton.addEventListener('click', () => {
                        selectedSubcategories = ['All'];
                        subcategoryButtons.querySelectorAll('.selection-button').forEach(btn => {
                            btn.classList.toggle('selected', btn === allButton);
                        });
                        updateLevelButtons();
                        updateStartButtonState();
                    });
                    subcategoryButtons.appendChild(allButton);
                } else {
                    selectedSubcategories = subs.length === 1 ? [subs[0]] : ['null'];
                    updateLevelButtons();
                    updateStartButtonState();
                }
            }
        }

        // Level button handlers
        function updateLevelButtons() {
            levelButtons.innerHTML = '';
            levelGroup.style.display = selectedCategory ? 'block' : 'none';
            if (selectedCategory) {
                const maxLevel = getMaxUnlockedLevel(selectedCategory);
                for (let i = 1; i <= maxLevel; i++) {
                    const button = document.createElement('button');
                    button.className = 'selection-button';
                    button.setAttribute('data-level', i);
                    button.textContent = `Level ${i}`;
                    if (selectedLevel === i) {
                        button.classList.add('selected');
                    }
                    button.addEventListener('click', () => {
                        selectedLevel = parseInt(i);
                        levelButtons.querySelectorAll('.selection-button').forEach(btn => btn.classList.remove('selected'));
                        button.classList.add('selected');
                        updateStartButtonState();
                    });
                    levelButtons.appendChild(button);
                }
            }
            updateStartButtonState();
        }

        // Number of questions button handlers
        numQuestionsButtons.querySelectorAll('.selection-button').forEach(button => {
            button.addEventListener('click', () => {
                selectedNumQuestions = parseInt(button.getAttribute('data-num-questions'));
                numQuestionsButtons.querySelectorAll('.selection-button').forEach(btn => btn.classList.remove('selected'));
                button.classList.add('selected');
                updateStartButtonState();
            });
        });

        function getMaxUnlockedLevel(category) {
            if (!categoryXPAmt[category]) return 1;
            const xp = Object.values(categoryXPAmt[category] || {}).reduce((sum, xp) => sum + xp, 0);
            if (xp >= 1400) return 5;
            if (xp >= 900) return 4;
            if (xp >= 500) return 3;
            if (xp >= 100) return 2;
            return 1;
        }

        function updateStartButtonState() {
            startGameButton.disabled = !selectedCategory || !selectedNumQuestions || selectedLevel === null || 
                (subcategories[selectedCategory].length > 1 && selectedSubcategories.length === 0);
        }

        startGameButton.addEventListener('click', () => {
            if (!selectedCategory || !selectedNumQuestions || selectedLevel === null || 
                (subcategories[selectedCategory].length > 1 && selectedSubcategories.length === 0)) {
                alert('Please select a category, at least one subcategory (if required), number of questions, and level');
                return;
            }
            const file = categoryFiles[selectedCategory]; // Use file from category.json
            const params = new URLSearchParams({
                file: file,
                subcategories: selectedSubcategories.join(','),
                level: selectedLevel,
                numQuestions: selectedNumQuestions
            }).toString();
            window.location.href = `./quiz.html?${params}`;
        });

        function startGame(category, subcategories, level) {
            gameLevel = parseInt(level);
            selectedLevel = parseInt(level);
            console.log('Starting game with:', { category, subcategories, level: gameLevel, selectedLevel });
            sidebar.style.display = 'none';
            gameContainer.classList.add('fullscreen');
            selectionContainer.style.display = 'none';
            questionContainer.style.display = 'block';
            subcategoryHeader.textContent = subcategories[0] === 'All' ? 'All' : subcategories.map(s => s === 'null' ? 'General' : s).join(' - ');
            selectQuestion(category, subcategories, gameLevel);
        }

        function selectQuestion(category, subcategories, level) {
            console.log('Selecting question with:', { category, subcategories, level, selectedLevel, questionsAnswered, selectedNumQuestions, usedQuestions: Array.from(usedQuestionIds) });
            alert(`No questions loaded yet for ${category} at level ${level}. Please add question loading logic.`);
            endGame();
        }

        function shuffleAnswers(answers, correctIndex) {
            const shuffled = [...answers];
            const indexMap = Array.from({ length: answers.length }, (_, i) => i); // Track original indices
            console.log('Before shuffle:', { originalAnswers: [...answers], correctIndex, correctAnswer: answers[correctIndex] });
            for (let i = shuffled.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                console.log(`Swap: i=${i}, j=${j}, before=[${shuffled}], indexMap=[${indexMap}]`);
                [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]]; // Swap values
                [indexMap[i], indexMap[j]] = [indexMap[j], indexMap[i]]; // Swap corresponding indices
                console.log(`After swap: shuffled=[${shuffled}], indexMap=[${indexMap}]`);
            }
            // Find the new index of the original correct answer
            const newCorrectIndex = indexMap.indexOf(correctIndex);
            console.log('After shuffle:', { shuffledAnswers: [...shuffled], newCorrectIndex, correctAnswer: shuffled[newCorrectIndex] });
            return { shuffledAnswers: shuffled, newCorrectIndex };
        }

        function displayQuestion() {
            if (selectedSubcategories[0] === 'All') {
                subcategoryHeader.textContent = currentQuestion.subcategory.map(s => s === 'null' ? 'General' : s).join(' - ');
            } else {
                subcategoryHeader.textContent = selectedSubcategories.map(s => s === 'null' ? 'General' : s).join(' - ');
            }
            questionText.textContent = currentQuestion.question;
            answersContainer.innerHTML = '';
            resultText.textContent = '';
            resultText.style.color = ''; // Reset to default (white)
            playAgainButton.style.display = 'none';

            const { shuffledAnswers, newCorrectIndex } = shuffleAnswers(currentQuestion.answers, currentQuestion.correct);
            currentQuestion.correct = newCorrectIndex; // Update correct index
            currentQuestion.shuffledAnswers = shuffledAnswers; // Store shuffled answers
            currentQuestion.correctAnswer = shuffledAnswers[newCorrectIndex]; // Explicitly set correct answer from shuffled array

            console.log('Displaying question:', {
                id: currentQuestion.id,
                question: currentQuestion.question,
                subcategory: currentQuestion.subcategory,
                level: currentQuestion.level,
                answers: shuffledAnswers,
                correct: newCorrectIndex,
                correctAnswer: currentQuestion.correctAnswer
            });

            shuffledAnswers.forEach((answer, index) => {
                const button = document.createElement('button');
                button.className = 'answer-btn';
                button.textContent = answer;
                button.setAttribute('data-index', index); // Store shuffled index
                button.addEventListener('click', (e) => {
                    const clickedIndex = parseInt(e.target.getAttribute('data-index'));
                    console.log('Button clicked:', { text: answer, clickedIndex, expectedCorrect: newCorrectIndex });
                    checkAnswer(clickedIndex);
                });
                answersContainer.appendChild(button);
            });
        }

        function checkAnswer(selectedIndex) {
            console.log('Checking answer:', {
                selectedIndex,
                selectedAnswer: currentQuestion.answers[selectedIndex], // Original answer at selected index
                shuffledSelectedAnswer: currentQuestion.shuffledAnswers[selectedIndex], // Shuffled answer
                correctIndex: currentQuestion.correct,
                correctAnswer: currentQuestion.correctAnswer // Use the stored correct answer
            });
            const isCorrect = selectedIndex === currentQuestion.correct;
            const xpEarned = isCorrect ? currentQuestion.level * 5 : currentQuestion.level * 1;
            answersContainer.querySelectorAll('.answer-btn').forEach(btn => btn.disabled = true);
            if (isCorrect) {
                resultText.textContent = 'Correct!';
                resultText.style.color = ''; // Ensure white for "Correct!"
                setTimeout(() => {
                    questionsAnswered++;
                    updateUserStats(currentQuestion.category, currentQuestion.subcategory, xpEarned);
                    if (questionsAnswered >= selectedNumQuestions) {
                        playAgainButton.style.display = 'block';
                    } else {
                        selectQuestion(selectedCategory, selectedSubcategories, gameLevel);
                    }
                }, settings.correctDelay || 500);
            } else {
                resultText.textContent = currentQuestion.explanation || `The correct answer is ${currentQuestion.correctAnswer}.`;
                resultText.style.color = '#ff0000'; // Red for explanation
                questionsAnswered++;
                updateUserStats(currentQuestion.category, currentQuestion.subcategory, xpEarned);
                setTimeout(() => {
                    if (questionsAnswered >= selectedNumQuestions) {
                        playAgainButton.style.display = 'block';
                    } else {
                        selectQuestion(selectedCategory, selectedSubcategories, gameLevel);
                    }
                }, settings.explanationDelay || 1000);
            }
        }

        function updateUserStats(category, subcategories, xp) {
            console.log('Updating XP for:', { category, subcategories, xp });
            console.log('Current categoryXPAmt:', JSON.stringify(categoryXPAmt));

            userXP += xp;
            if (!categoryXPAmt[category]) categoryXPAmt[category] = {};
            subcategories.forEach(sub => {
                const subKey = sub || 'null';
                if (!categoryXPAmt[category][subKey]) categoryXPAmt[category][subKey] = 0;
                categoryXPAmt[category][subKey] += xp;
            });

            localStorage.setItem('triviaUserXP', userXP);
            localStorage.setItem('triviaCategoryXP', JSON.stringify(categoryXPAmt));
            updateXPBars();
        }

        function updateXPBars() {
            totalXP.textContent = userXP;
            totalXPBar.value = userXP % 1000;
            let barsHTML = '';
            for (const category of categories) {
                const categoryTotalXP = Object.values(categoryXPAmt[category] || {}).reduce((sum, xp) => sum + xp, 0);
                const categoryLevel = getMaxUnlockedLevel(category);
                barsHTML += `
                    <div class="xp-bar">
                        <div class="category-header" data-category="${category}">${category} - Level ${categoryLevel}</div>
                        <progress max="1000" value="${categoryTotalXP % 1000}"></progress>
                        <div class="subcategory-list" id="subcategory-${category}">
                `;
                for (const sub of subcategories[category]) {
                    const subDisplay = sub === 'null' ? 'General' : sub;
                    const xp = categoryXPAmt[category] ? categoryXPAmt[category][sub] || 0 : 0;
                    barsHTML += `<label>${subDisplay}: ${xp}</label><progress max="1000" value="${xp % 1000}"></progress>`;
                }
                barsHTML += '</div></div>';
            }
            categoryXPBars.innerHTML = barsHTML;

            // Add click listeners for tree control
            document.querySelectorAll('.category-header').forEach(header => {
                header.addEventListener('click', () => {
                    const category = header.getAttribute('data-category');
                    const subcategoryList = document.getElementById(`subcategory-${category}`);
                    const isCollapsed = subcategoryList.classList.contains('visible');
                    subcategoryList.classList.toggle('visible', !isCollapsed);
                    header.classList.toggle('collapsed', !isCollapsed);
                });
            });

            // Initially collapse all subcategories
            document.querySelectorAll('.subcategory-list').forEach(list => {
                list.classList.remove('visible');
            });
            document.querySelectorAll('.category-header').forEach(header => {
                header.classList.remove('collapsed');
            });
        }

        playAgainButton.addEventListener('click', () => {
            endGame();
        });

        function endGame() {
            sidebar.style.display = 'block';
            gameContainer.classList.remove('fullscreen');
            questionContainer.style.display = 'none';
            selectionContainer.style.display = 'block';
            playAgainButton.style.display = 'none';
            currentQuestion = null;
            questionsAnswered = 0;
            usedQuestionIds.clear();
            gameLevel = null;
            subcategoryHeader.textContent = '';
            updateLevelButtons();
        }

        // Reset data and redirect to login
        resetButton.addEventListener('click', () => {
            if (confirm('Are you sure you want to reset all progress?')) {
                // Clear UI state before redirecting
                resultText.textContent = '';
                answersContainer.innerHTML = '';
                questionText.textContent = '';
                subcategoryHeader.textContent = '';
                playAgainButton.style.display = 'none';
                localStorage.removeItem('triviaUserXP');
                localStorage.removeItem('triviaCategoryXP');
                localStorage.removeItem('triviaHighScores');
                localStorage.removeItem('triviaSettings');
                window.location.href = './index.html';
            }
        });

        // Logout
        logoutButton.addEventListener('click', () => {
            localStorage.removeItem('triviaSettings');
            window.location.href = './index.html';
        });
    </script>
</body>
</html>