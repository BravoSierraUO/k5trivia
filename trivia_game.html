<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trivia Game</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            background-color: #000000; 
            color: #ffffff; 
            margin: 20px; 
            display: flex; 
            font-size: 22px; 
            height: calc(100vh - 40px); 
            box-sizing: border-box; 
        }
        #sidebar { 
            width: 300px; 
            background: #1a1a1a; 
            padding: 25px; 
            box-shadow: 2px 0 5px rgba(0,0,0,0.5); 
            box-sizing: border-box; 
            font-size: 18px; 
            display: flex;
            flex-direction: column;
        }
        #game-container { 
            flex: 1; 
            padding: 25px; 
            transition: all 0.3s; 
            box-sizing: border-box; 
        }
        #game-container.fullscreen { 
            margin: 0; 
            padding: 25px; 
            width: calc(100vw - 40px); 
            height: calc(100vh - 40px); 
        }
        #selection-container { margin-bottom: 25px; }
        #question-container { 
            background: #1a1a1a; 
            padding: 25px; 
            border-radius: 8px; 
            box-shadow: 0 0 10px rgba(0,0,0,0.5); 
            height: 100%; 
            box-sizing: border-box; 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
        }
        #subcategory-header { 
            font-size: 24px; 
            margin-bottom: 20px; 
            text-align: center; 
        }
        #question-text { 
            font-size: 24px; 
            margin-bottom: 20px; 
            text-align: center; 
        }
        #answers-container { 
            display: grid; 
            grid-template-columns: repeat(2, 1fr); 
            gap: 15px; 
            margin-bottom: 20px; 
        }
        #result-text { 
            font-size: 28px; 
            text-align: center; 
            margin-top: 20px; 
        }
        #play-again-btn { 
            margin: 20px auto 0; 
            text-align: center; 
            display: none; 
        }
        .answer-btn { 
            padding: 20px; 
            background: #007BFF; 
            color: white; 
            border: none; 
            border-radius: 5px; 
            cursor: pointer; 
            font-size: 22px; 
        }
        .answer-btn:hover { background: #0056b3; }
        #start-game-btn, #play-again-btn, #reset-btn, #logout-btn { 
            padding: 20px 30px; 
            background: #28a745; 
            color: white; 
            border: none; 
            border-radius: 5px; 
            cursor: pointer; 
            font-size: 18px; 
        }
        #start-game-btn:disabled, #play-again-btn:disabled { 
            background: #6c757d; 
            cursor: not-allowed; 
        }
        #reset-btn { background: #dc3545; }
        #reset-btn:hover { background: #c82333; }
        #logout-btn { background: #6c757d; }
        #logout-btn:hover { background: #5a6268; }
        .selection-group { margin: 20px 0; }
        .selection-group label { display: block; margin-bottom: 15px; font-size: 24px; }
        .selection-button { 
            margin: 8px; 
            padding: 15px 20px; 
            background: #333333; 
            color: #ffffff; 
            border: 1px solid #555555; 
            border-radius: 5px; 
            cursor: pointer; 
            font-size: 22px; 
        }
        .selection-button.selected { 
            background: #007BFF; 
            border-color: #007BFF; 
            box-shadow: 0 0 5px rgba(0, 123, 255, 0.5); 
        }
        .selection-button:disabled { 
            background: #6c757d; 
            cursor: not-allowed; 
        }
        .xp-bar { margin: 20px 0; }
        .xp-bar label { display: block; font-size: 16px; }
        .xp-bar progress { width: 100%; height: 30px; }
        .category-header, #settings-header { 
            cursor: pointer; 
            font-weight: bold; 
            font-size: 20px; 
            display: flex; 
            align-items: center; 
        }
        .category-header::before, #settings-header::before { 
            content: '▶'; 
            margin-right: 10px; 
        }
        .category-header.collapsed::before, #settings-header.collapsed::before { 
            content: '▼'; 
        }
        .subcategory-list, #settings-content { 
            display: none; 
            margin-left: 20px; 
        }
        .subcategory-list.visible, #settings-content.visible { 
            display: block; 
        }
        #delay-setting { margin: 25px 0; }
        #delay-setting label { display: block; margin-bottom: 15px; font-size: 18px; }
        #delay-setting input { 
            width: 140px; 
            margin-bottom: 20px; 
            background: #333333; 
            color: #ffffff; 
            border: 1px solid #555555; 
            font-size: 18px; 
            padding: 8px; 
        }
        #version-display { 
            position: fixed; 
            bottom: 30px; 
            right: 30px; 
            color: #ffffff; 
            font-size: 20px; 
        }
        #xp-bars-container {
            flex: 1; 
            overflow-y: auto;
            margin-bottom: 20px;
        }
        #settings-header {
            margin-top: auto; 
            position: sticky;
            bottom: 0;
            background: #1a1a1a; 
            padding: 10px 0;
        }
    </style>
</head>
<body>
    <div id="sidebar">
        <h3>Stats & Settings</h3>
        <div class="xp-bar">
            <label>Total XP: <span id="total-xp">0</span></label>
            <progress id="total-xp-bar" max="1000" value="0"></progress>
        </div>
        <div id="xp-bars-container">
            <div id="category-xp-bars"></div>
        </div>
        <div id="settings-header">
            <span>Settings</span>
            <button id="logout-btn">Logout</button>
        </div>
        <div id="settings-content">
            <div id="delay-setting">
                <label for="correct-delay">Time to Display "Correct" (ms):</label>
                <input type="number" id="correct-delay" min="0" max="5000" step="100" value="500">
                <label for="explanation-delay">Time to Display Explanation (ms):</label>
                <input type="number" id="explanation-delay" min="0" max="5000" step="100" value="1000">
            </div>
            <button id="reset-btn">Reset Data</button>
        </div>
    </div>
    <div id="game-container">
        <div id="selection-container">
            <div class="selection-group">
                <label>Select Category:</label>
                <div id="category-buttons"></div>
            </div>
            <div class="selection-group" id="subcategory-group" style="display: none;">
                <label>Select Subcategory:</label>
                <div id="subcategory-buttons"></div>
            </div>
            <div class="selection-group" id="level-group" style="display: none;">
                <label>Select Level:</label>
                <div id="level-buttons"></div>
            </div>
            <div class="selection-group">
                <label>Select Number of Questions:</label>
                <div id="num-questions-buttons">
                    <button class="selection-button" data-num-questions="5">5</button>
                    <button class="selection-button" data-num-questions="10">10</button>
                    <button class="selection-button" data-num-questions="15">15</button>
                    <button class="selection-button" data-num-questions="20">20</button>
                </div>
            </div>
            <button id="start-game-btn" disabled>Start Game</button>
        </div>
        <div id="question-container" style="display: none;">
            <h2 id="subcategory-header"></h2>
            <h2 id="question-text"></h2>
            <div id="answers-container"></div>
            <p id="result-text"></p>
            <button id="play-again-btn" style="display: none;">Back to Main</button>
        </div>
    </div>
    <div id="version-display">Version 1.2.003</div>

    <script>
        // Check for logged-in user
        const settings = JSON.parse(localStorage.getItem('triviaSettings')) || { correctDelay: 500, explanationDelay: 1000 };
        if (!settings || !settings.loggedIn) {
            window.location.href = './login.html';
        }

        let questions = [];
        let categories = [];
        let subcategories = {};
        let currentQuestion = null;
        let userXP = parseInt(localStorage.getItem('triviaUserXP')) || 0;
        let categoryXPAmt = JSON.parse(localStorage.getItem('triviaCategoryXP')) || {};
        let selectedNumQuestions = 0;
        let questionsAnswered = 0;
        let selectedLevel = null;
        let gameLevel = null;
        let selectedCategory = null;
        let selectedSubcategories = [];
        let usedQuestionIds = new Set();
        const startGameButton = document.getElementById('start-game-btn');
        const questionContainer = document.getElementById('question-container');
        const selectionContainer = document.getElementById('selection-container');
        const questionText = document.getElementById('question-text');
        const answersContainer = document.getElementById('answers-container');
        const resultText = document.getElementById('result-text');
        const playAgainButton = document.getElementById('play-again-btn');
        const categoryButtons = document.getElementById('category-buttons');
        const subcategoryButtons = document.getElementById('subcategory-buttons');
        const levelButtons = document.getElementById('level-buttons');
        const numQuestionsButtons = document.getElementById('num-questions-buttons');
        const subcategoryGroup = document.getElementById('subcategory-group');
        const levelGroup = document.getElementById('level-group');
        const totalXP = document.getElementById('total-xp');
        const totalXPBar = document.getElementById('total-xp-bar');
        const categoryXPBars = document.getElementById('category-xp-bars');
        const resetButton = document.getElementById('reset-btn');
        const logoutButton = document.getElementById('logout-btn');
        const correctDelayInput = document.getElementById('correct-delay');
        const explanationDelayInput = document.getElementById('explanation-delay');
        const sidebar = document.getElementById('sidebar');
        const gameContainer = document.getElementById('game-container');
        const subcategoryHeader = document.getElementById('subcategory-header');
        const settingsHeader = document.getElementById('settings-header');
        const settingsContent = document.getElementById('settings-content');

        // Initialize delay settings
        correctDelayInput.value = settings.correctDelay || 500;
        explanationDelayInput.value = settings.explanationDelay || 1000;
        correctDelayInput.addEventListener('change', () => {
            settings.correctDelay = parseInt(correctDelayInput.value) || 500;
            localStorage.setItem('triviaSettings', JSON.stringify(settings));
        });
        explanationDelayInput.addEventListener('change', () => {
            settings.explanationDelay = parseInt(explanationDelayInput.value) || 1000;
            localStorage.setItem('triviaSettings', JSON.stringify(settings));
        });

        // Settings header toggle
        settingsHeader.addEventListener('click', (e) => {
            if (e.target.id === 'logout-btn') return; // Prevent toggle on logout button click
            const isCollapsed = settingsContent.classList.contains('visible');
            settingsContent.classList.toggle('visible', !isCollapsed);
            settingsHeader.classList.toggle('collapsed', !isCollapsed);
        });

        // Load questions and extract categories/subcategories
        fetch('./questions.json?_=' + Date.now())
            .then(response => {
                if (!response.ok) throw new Error('Network response was not ok');
                return response.json();
            })
            .then(data => {
                questions = data;
                questions.forEach((q, index) => {
                    q.id = index;
                    if (!q.category || typeof q.category !== 'string' || q.category.trim() === '') {
                        throw new Error(`Invalid question format: missing or invalid category at index ${index}`);
                    }
                    // Handle subcategory as array, string, or null
                    if (q.subcategory === null || q.subcategory === undefined) {
                        q.subcategory = ['null'];
                    } else if (typeof q.subcategory === 'string') {
                        q.subcategory = [q.subcategory];
                    } else if (!Array.isArray(q.subcategory) || q.subcategory.length === 0 || !q.subcategory.every(s => typeof s === 'string' && s.trim() !== '')) {
                        throw new Error(`Invalid subcategory format at index ${index}: must be a string, null, or array of non-empty strings`);
                    }
                    q.level = parseInt(q.level);
                    if (isNaN(q.level)) {
                        throw new Error(`Invalid level format for question at index ${index}: ${q.level}`);
                    }
                    if (!Array.isArray(q.answers) || q.answers.length < 2) {
                        throw new Error(`Invalid answers format at index ${index}: must be an array with at least 2 answers`);
                    }
                    if (typeof q.correct !== 'number' || q.correct < 0 || q.correct >= q.answers.length) {
                        throw new Error(`Invalid correct index at index ${index}: ${q.correct}`);
                    }
                });

                // Extract unique categories and subcategories
                categories = [...new Set(questions.map(q => q.category))].sort();
                subcategories = {};
                categories.forEach(cat => {
                    const subs = [...new Set(questions.filter(q => q.category === cat).flatMap(q => q.subcategory))].sort();
                    subcategories[cat] = subs.filter(s => s !== 'null').concat(subs.includes('null') ? ['null'] : []);
                });

                // Initialize categoryXPAmt for new categories/subcategories
                categories.forEach(cat => {
                    if (!categoryXPAmt[cat]) categoryXPAmt[cat] = {};
                    subcategories[cat].forEach(sub => {
                        if (!categoryXPAmt[cat][sub]) categoryXPAmt[cat][sub] = 0;
                    });
                });

                // Clean categoryXPAmt
                cleanCategoryXPAmt();

                // Populate category buttons
                categoryButtons.innerHTML = '';
                categories.forEach(cat => {
                    const button = document.createElement('button');
                    button.className = 'selection-button';
                    button.setAttribute('data-category', cat);
                    button.textContent = cat;
                    button.addEventListener('click', () => {
                        selectedCategory = cat;
                        selectedSubcategories = [];
                        categoryButtons.querySelectorAll('.selection-button').forEach(btn => btn.classList.remove('selected'));
                        button.classList.add('selected');
                        updateSubcategoryButtons();
                        updateLevelButtons();
                        updateStartButtonState();
                    });
                    categoryButtons.appendChild(button);
                });

                startGameButton.disabled = false;
                console.log('Questions loaded:', questions.length);
                console.log('Categories:', categories);
                console.log('Subcategories:', subcategories);
                console.log('First 5 questions:', questions.slice(0, 5).map(q => ({ id: q.id, category: q.category, subcategory: q.subcategory, level: q.level })));
                updateXPBars();
            })
            .catch(error => {
                console.error('Error loading questions:', error);
                startGameButton.disabled = true;
                startGameButton.textContent = 'Error Loading Questions';
            });

        // Validate and clean categoryXPAmt, and sync userXP
        function cleanCategoryXPAmt() {
            let totalXP = 0;
            for (const category in categoryXPAmt) {
                if (!categories.includes(category)) {
                    delete categoryXPAmt[category];
                    continue;
                }
                for (const sub in categoryXPAmt[category]) {
                    if (!subcategories[category].includes(sub)) {
                        delete categoryXPAmt[category][sub];
                    } else {
                        totalXP += categoryXPAmt[category][sub];
                    }
                }
            }
            userXP = totalXP;
            localStorage.setItem('triviaUserXP', userXP);
            localStorage.setItem('triviaCategoryXP', JSON.stringify(categoryXPAmt));
        }

        // Subcategory button handlers
        function updateSubcategoryButtons() {
            subcategoryButtons.innerHTML = '';
            subcategoryGroup.style.display = 'none';
            selectedSubcategories = [];
            if (selectedCategory) {
                const subs = subcategories[selectedCategory];
                if (subs.length > 1 || (subs.length === 1 && subs[0] !== 'null')) {
                    subcategoryGroup.style.display = 'block';
                    subs.forEach(sub => {
                        const button = document.createElement('button');
                        button.className = 'selection-button';
                        button.setAttribute('data-subcategory', sub);
                        button.textContent = sub === 'null' ? 'General' : sub;
                        button.addEventListener('click', () => {
                            if (selectedSubcategories.includes(sub)) {
                                selectedSubcategories = selectedSubcategories.filter(s => s !== sub);
                                button.classList.remove('selected');
                            } else {
                                selectedSubcategories.push(sub);
                                button.classList.add('selected');
                            }
                            updateLevelButtons();
                            updateStartButtonState();
                        });
                        subcategoryButtons.appendChild(button);
                    });
                    // Add "All" option
                    const allButton = document.createElement('button');
                    allButton.className = 'selection-button';
                    allButton.setAttribute('data-subcategory', 'All');
                    allButton.textContent = 'All';
                    allButton.addEventListener('click', () => {
                        selectedSubcategories = ['All'];
                        subcategoryButtons.querySelectorAll('.selection-button').forEach(btn => {
                            btn.classList.toggle('selected', btn === allButton);
                        });
                        updateLevelButtons();
                        updateStartButtonState();
                    });
                    subcategoryButtons.appendChild(allButton);
                } else {
                    selectedSubcategories = subs.length === 1 ? [subs[0]] : ['null'];
                    updateLevelButtons();
                    updateStartButtonState();
                }
            }
        }

        // Level button handlers
        function updateLevelButtons() {
            levelButtons.innerHTML = '';
            levelGroup.style.display = selectedCategory ? 'block' : 'none';
            if (selectedCategory) {
                const maxLevel = getMaxUnlockedLevel(selectedCategory);
                for (let i = 1; i <= maxLevel; i++) {
                    const button = document.createElement('button');
                    button.className = 'selection-button';
                    button.setAttribute('data-level', i);
                    button.textContent = `Level ${i}`;
                    if (selectedLevel === i) {
                        button.classList.add('selected');
                    }
                    button.addEventListener('click', () => {
                        selectedLevel = parseInt(i);
                        levelButtons.querySelectorAll('.selection-button').forEach(btn => btn.classList.remove('selected'));
                        button.classList.add('selected');
                        updateStartButtonState();
                    });
                    levelButtons.appendChild(button);
                }
            }
            updateStartButtonState();
        }

        // Number of questions button handlers
        numQuestionsButtons.querySelectorAll('.selection-button').forEach(button => {
            button.addEventListener('click', () => {
                selectedNumQuestions = parseInt(button.getAttribute('data-num-questions'));
                numQuestionsButtons.querySelectorAll('.selection-button').forEach(btn => btn.classList.remove('selected'));
                button.classList.add('selected');
                updateStartButtonState();
            });
        });

        function getMaxUnlockedLevel(category) {
            if (!categoryXPAmt[category]) return 1;
            const xp = Object.values(categoryXPAmt[category]).reduce((sum, xp) => sum + xp, 0);
            if (xp >= 1400) return 5;
            if (xp >= 900) return 4;
            if (xp >= 500) return 3;
            if (xp >= 200) return 2;
            return 1;
        }

        function updateStartButtonState() {
            startGameButton.disabled = !selectedCategory || !selectedNumQuestions || selectedLevel === null || 
                (subcategories[selectedCategory].length > 1 && selectedSubcategories.length === 0);
        }

        startGameButton.addEventListener('click', () => {
            if (!selectedCategory || !selectedNumQuestions || selectedLevel === null || 
                (subcategories[selectedCategory].length > 1 && selectedSubcategories.length === 0)) {
                alert('Please select a category, at least one subcategory (if required), number of questions, and level');
                return;
            }
            questionsAnswered = 0;
            usedQuestionIds.clear();
            startGame(selectedCategory, selectedSubcategories, selectedLevel);
        });

        function startGame(category, subcategories, level) {
            gameLevel = parseInt(level);
            selectedLevel = parseInt(level);
            console.log('Starting game with:', { category, subcategories, level: gameLevel, selectedLevel });
            sidebar.style.display = 'none';
            gameContainer.classList.add('fullscreen');
            selectionContainer.style.display = 'none';
            questionContainer.style.display = 'block';
            subcategoryHeader.textContent = subcategories[0] === 'All' ? 'All' : subcategories.map(s => s === 'null' ? 'General' : s).join(' - ');
            selectQuestion(category, subcategories, gameLevel);
        }

        function selectQuestion(category, subcategories, level) {
            console.log('Selecting question with:', { category, subcategories, level, selectedLevel, questionsAnswered, selectedNumQuestions, usedQuestions: Array.from(usedQuestionIds) });
            let filteredQuestions = questions.filter(q => 
                q.category === category && 
                q.level === parseInt(level) && 
                !usedQuestionIds.has(q.id)
            );
            if (subcategories[0] === 'All') {
                filteredQuestions = filteredQuestions.filter(q => q.subcategory.some(s => subcategories[category].includes(s)));
            } else {
                filteredQuestions = filteredQuestions.filter(q => subcategories.every(sub => q.subcategory.includes(sub)));
            }

            console.log('Filtered questions:', filteredQuestions.length, filteredQuestions.map(q => ({ id: q.id, question: q.question, subcategory: q.subcategory, level: q.level })));

            if (filteredQuestions.length === 0) {
                if (questionsAnswered === 0) {
                    alert(`No questions available for ${category} (${subcategories.join(', ')}) at level ${level}`);
                    endGame();
                    return;
                }
                playAgainButton.style.display = 'block';
                return;
            }

            currentQuestion = filteredQuestions[Math.floor(Math.random() * filteredQuestions.length)];
            usedQuestionIds.add(currentQuestion.id);
            displayQuestion();
        }

        function shuffleAnswers(answers, correctIndex) {
            const shuffled = [...answers];
            let newCorrectIndex = correctIndex;
            for (let i = shuffled.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
                if (newCorrectIndex === i) newCorrectIndex = j;
                else if (newCorrectIndex === j) newCorrectIndex = i;
            }
            return { shuffledAnswers: shuffled, newCorrectIndex };
        }

        function displayQuestion() {
            if (selectedSubcategories[0] === 'All') {
                subcategoryHeader.textContent = currentQuestion.subcategory.map(s => s === 'null' ? 'General' : s).join(' - ');
            } else {
                subcategoryHeader.textContent = selectedSubcategories.map(s => s === 'null' ? 'General' : s).join(' - ');
            }
            questionText.textContent = currentQuestion.question;
            answersContainer.innerHTML = '';
            resultText.textContent = '';
            resultText.style.color = ''; // Reset to default (white)
            playAgainButton.style.display = 'none';

            const { shuffledAnswers, newCorrectIndex } = shuffleAnswers(currentQuestion.answers, currentQuestion.correct);
            currentQuestion.correct = newCorrectIndex;

            console.log('Displaying question:', {
                id: currentQuestion.id,
                question: currentQuestion.question,
                subcategory: currentQuestion.subcategory,
                level: currentQuestion.level,
                answers: shuffledAnswers,
                correct: newCorrectIndex
            });

            shuffledAnswers.forEach((answer, index) => {
                const button = document.createElement('button');
                button.className = 'answer-btn';
                button.textContent = answer;
                button.addEventListener('click', () => checkAnswer(index));
                answersContainer.appendChild(button);
            });
        }

        function checkAnswer(selectedIndex) {
            const isCorrect = selectedIndex === currentQuestion.correct;
            const xpEarned = isCorrect ? currentQuestion.level * 5 : currentQuestion.level * 1;
            answersContainer.querySelectorAll('.answer-btn').forEach(btn => btn.disabled = true);
            if (isCorrect) {
                resultText.textContent = 'Correct!';
                resultText.style.color = ''; // Ensure white for "Correct!"
                setTimeout(() => {
                    questionsAnswered++;
                    updateUserStats(currentQuestion.category, currentQuestion.subcategory, xpEarned);
                    if (questionsAnswered >= selectedNumQuestions) {
                        playAgainButton.style.display = 'block';
                    } else {
                        selectQuestion(selectedCategory, selectedSubcategories, gameLevel);
                    }
                }, settings.correctDelay || 500);
            } else {
                resultText.textContent = currentQuestion.explanation;
                resultText.style.color = '#ff0000'; // Red for explanation
                questionsAnswered++;
                updateUserStats(currentQuestion.category, currentQuestion.subcategory, xpEarned);
                setTimeout(() => {
                    if (questionsAnswered >= selectedNumQuestions) {
                        playAgainButton.style.display = 'block';
                    } else {
                        selectQuestion(selectedCategory, selectedSubcategories, gameLevel);
                    }
                }, settings.explanationDelay || 1000);
            }
        }

        function updateUserStats(category, subcategories, xp) {
            console.log('Updating XP for:', { category, subcategories, xp });
            console.log('Current categoryXPAmt:', JSON.stringify(categoryXPAmt));

            userXP += xp;
            if (!categoryXPAmt[category]) categoryXPAmt[category] = {};
            subcategories.forEach(sub => {
                const subKey = sub || 'null';
                if (!categoryXPAmt[category][subKey]) categoryXPAmt[category][subKey] = 0;
                categoryXPAmt[category][subKey] += xp;
            });

            localStorage.setItem('triviaUserXP', userXP);
            localStorage.setItem('triviaCategoryXP', JSON.stringify(categoryXPAmt));
            updateXPBars();
        }

        function updateXPBars() {
            totalXP.textContent = userXP;
            totalXPBar.value = userXP % 1000;
            let barsHTML = '';
            for (const category of categories) {
                const categoryTotalXP = Object.values(categoryXPAmt[category] || {}).reduce((sum, xp) => sum + xp, 0);
                const categoryLevel = getMaxUnlockedLevel(category);
                barsHTML += `
                    <div class="xp-bar">
                        <div class="category-header" data-category="${category}">${category} - Level ${categoryLevel}</div>
                        <progress max="1000" value="${categoryTotalXP % 1000}"></progress>
                        <div class="subcategory-list" id="subcategory-${category}">
                `;
                for (const sub of subcategories[category]) {
                    const subDisplay = sub === 'null' ? 'General' : sub;
                    const xp = categoryXPAmt[category] ? categoryXPAmt[category][sub] || 0 : 0;
                    barsHTML += `<label>${subDisplay}: ${xp}</label><progress max="1000" value="${xp % 1000}"></progress>`;
                }
                barsHTML += '</div></div>';
            }
            categoryXPBars.innerHTML = barsHTML;

            // Add click listeners for tree control
            document.querySelectorAll('.category-header').forEach(header => {
                header.addEventListener('click', () => {
                    const category = header.getAttribute('data-category');
                    const subcategoryList = document.getElementById(`subcategory-${category}`);
                    const isCollapsed = subcategoryList.classList.contains('visible');
                    subcategoryList.classList.toggle('visible', !isCollapsed);
                    header.classList.toggle('collapsed', !isCollapsed);
                });
            });

            // Initially collapse all subcategories
            document.querySelectorAll('.subcategory-list').forEach(list => {
                list.classList.remove('visible');
            });
            document.querySelectorAll('.category-header').forEach(header => {
                header.classList.remove('collapsed');
            });

            // Initially collapse settings
            settingsContent.classList.remove('visible');
            settingsHeader.classList.remove('collapsed');

            updateLevelButtons();
        }

        playAgainButton.addEventListener('click', () => {
            endGame();
        });

        function endGame() {
            sidebar.style.display = 'block';
            gameContainer.classList.remove('fullscreen');
            questionContainer.style.display = 'none';
            selectionContainer.style.display = 'block';
            playAgainButton.style.display = 'none';
            currentQuestion = null;
            questionsAnswered = 0;
            usedQuestionIds.clear();
            gameLevel = null;
            subcategoryHeader.textContent = '';
            updateLevelButtons();
        }

        // Reset data and redirect to login
        resetButton.addEventListener('click', () => {
            if (confirm('Are you sure you want to reset all progress?')) {
                localStorage.removeItem('triviaUserXP');
                localStorage.removeItem('triviaCategoryXP');
                localStorage.removeItem('triviaHighScores');
                localStorage.removeItem('triviaSettings');
                window.location.href = './login.html';
            }
        });

        // Logout
        logoutButton.addEventListener('click', () => {
            localStorage.removeItem('triviaSettings');
            window.location.href = './login.html';
        });
    </script>
</body>
</html>