<!DOCTYPE html>
<html>
<head>
    <title>7th Grade Trivia Game</title>
    <meta charset="utf-8">
    <style>
        body {
            margin: 0;
            font-family: Arial, sans-serif;
            background-color: #1a3350;
        }
        .ui-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            color: white;
            background: rgba(0, 0, 0, 0.7);
            border: 2px solid white;
            border-radius: 5px;
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
        }
        .ui-overlay h2 {
            font-size: 36px;
            margin: 10px;
        }
        .ui-overlay h3 {
            font-size: 28px;
            margin: 10px;
            max-width: 80%;
        }
        .ui-overlay p {
            font-size: 24px;
            margin: 10px;
        }
        .button {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 15px;
            margin: 5px;
            cursor: pointer;
            font-size: 20px;
            border-radius: 5px;
        }
        .button:hover {
            background: #45a049;
        }
        .game-over {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            color: white;
            background: rgba(0, 0, 0, 0.7);
            border: 2px solid white;
            border-radius: 5px;
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
        }
        .game-over h2 {
            font-size: 36px;
            margin: 10px;
        }
        .game-over p {
            font-size: 24px;
            margin: 10px;
        }
        .game-over button {
            font-size: 20px;
            padding: 15px 30px;
        }
        .login-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            color: white;
            background: rgba(0, 0, 0, 0.7);
            border: 2px solid white;
            border-radius: 5px;
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
        }
        .login-screen h2 {
            font-size: 36px;
            margin: 10px;
        }
        .login-screen input {
            font-size: 20px;
            padding: 10px;
            margin: 10px;
            border-radius: 5px;
            border: none;
            width: 200px;
        }
        .login-screen button {
            font-size: 20px;
            padding: 15px 30px;
        }
        .login-screen #version {
            font-size: 16px;
            position: absolute;
            bottom: 10px;
            color: #ccc;
        }
        .selection-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            color: white;
            background: rgba(0, 0, 0, 0.7);
            border: 2px solid white;
            border-radius: 5px;
            box-sizing: border-box;
            display: flex;
            text-align: center;
        }
        .selection-screen .left-panel {
            width: 30%;
            padding: 20px;
            border-right: 1px solid white;
            overflow-y: auto;
        }
        .selection-screen .right-panel {
            width: 70%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }
        .selection-screen h2 {
            font-size: 36px;
            margin: 10px;
        }
        .selection-screen select {
            font-size: 20px;
            padding: 10px;
            margin: 10px;
            border-radius: 5px;
            border: none;
            width: 220px;
            background: #333;
            color: white;
        }
        .selection-screen select option:disabled {
            color: #666;
            background: #222;
        }
        .selection-screen input[type="number"] {
            font-size: 20px;
            padding: 10px;
            margin: 10px;
            border-radius: 5px;
            border: none;
            width: 200px;
            background: #333;
            color: white;
        }
        .selection-screen button {
            font-size: 20px;
            padding: 15px 30px;
        }
        .selection-screen h3 {
            font-size: 24px;
            margin: 10px;
        }
        .selection-screen p {
            font-size: 20px;
            margin: 5px;
        }
        .xp-bar {
            width: 80%;
            height: 20px;
            background: #333;
            border-radius: 5px;
            margin: 10px auto;
        }
        .xp-bar-fill {
            height: 100%;
            background: #4CAF50;
            border-radius: 5px;
            transition: width 0.5s;
        }
        .subcategory-xp-bar {
            width: 80%;
            height: 20px;
            background: #333;
            border-radius: 5px;
            margin: 10px auto;
        }
        .subcategory-xp-bar-fill {
            height: 100%;
            background: #4CAF50;
            border-radius: 5px;
            transition: width 0.5s;
        }
        .subcategory-xp-label {
            font-size: 18px;
            margin: 5px 0;
        }
        .stats-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 16px;
        }
        .stats-table th, .stats-table td {
            border: 1px solid white;
            padding: 8px;
            text-align: left;
        }
    </style>
</head>
<body>
    <div class="login-screen" id="login-screen">
        <h2>User Login</h2>
        <input type="text" id="username" placeholder="Enter your username" />
        <button id="login-button" class="button">Login</button>
        <p id="version">Version 1.1.005</p>
    </div>
    <div class="selection-screen" id="selection-screen" style="display: none;">
        <div class="left-panel">
            <h3>User Stats</h3>
            <p id="user-level">Level: 1</p>
            <p id="user-xp">XP: 0 / 100</p>
            <p id="category-xp">Category XP: 0</p>
            <p id="subcategory-xp" style="display: none;">Subcategory XP: 0</p>
            <div class="xp-bar">
                <div class="xp-bar-fill" id="xp-bar-fill" style="width: 0%;"></div>
            </div>
            <div id="subcategory-xp-bars" style="display: none;">
                <p class="subcategory-xp-label" id="life-science-xp-label">Life Science XP: 0</p>
                <div class="subcategory-xp-bar">
                    <div class="subcategory-xp-bar-fill" id="life-science-xp-bar-fill" style="width: 0%;"></div>
                </div>
                <p class="subcategory-xp-label" id="physical-science-xp-label">Physical Science XP: 0</p>
                <div class="subcategory-xp-bar">
                    <div class="subcategory-xp-bar-fill" id="physical-science-xp-bar-fill" style="width: 0%;"></div>
                </div>
                <p class="subcategory-xp-label" id="earth-space-science-xp-label">Earth and Space Science XP: 0</p>
                <div class="subcategory-xp-bar">
                    <div class="subcategory-xp-bar-fill" id="earth-space-science-xp-bar-fill" style="width: 0%;"></div>
                </div>
            </div>
            <h3>High Scores</h3>
            <table class="stats-table" id="high-scores-table">
                <thead>
                    <tr>
                        <th>Category</th>
                        <th>Subcategory</th>
                        <th>Level</th>
                        <th>High Score</th>
                    </tr>
                </thead>
                <tbody id="high-scores-body"></tbody>
            </table>
        </div>
        <div class="right-panel">
            <h2>Select Category and Level</h2>
            <select id="category">
                <option value="Science">Science</option>
                <option value="Social Studies">Social Studies</option>
                <option value="English">English</option>
                <option value="Harry Potter">Harry Potter</option>
            </select>
            <select id="subcategory" style="display: none;">
                <option value="All">All</option>
                <option value="Life Science">Life Science</option>
                <option value="Physical Science">Physical Science</option>
                <option value="Earth and Space Science">Earth and Space Science</option>
            </select>
            <select id="level">
                <option value="1">Level 1 (1st Grade)</option>
                <option value="2">Level 2 (2nd Grade)</option>
                <option value="3">Level 3 (3rd Grade)</option>
                <option value="4">Level 4 (4th Grade)</option>
                <option value="5">Level 5 (5th Grade)</option>
            </select>
            <input type="number" id="correct-duration" min="0.5" max="10" step="0.5" value="1" placeholder="Correct Response Duration (seconds)" />
            <input type="number" id="incorrect-duration" min="0.5" max="10" step="0.5" value="1" placeholder="Incorrect Response Duration (seconds)" />
            <button id="start-game" class="button" disabled>Loading Questions...</button>
            <button id="logout-button" class="button">Logout</button>
            <button id="reset-stats-button" class="button">Reset Stats</button>
        </div>
    </div>
    <div class="ui-overlay" id="ui" style="display: none;">
        <h2 id="category-display"></h2>
        <h3 id="question"></h3>
        <div id="answers"></div>
        <p id="feedback"></p>
    </div>
    <div id="game-over" class="game-over" style="display: none;">
        <h2 id="final-score"></h2>
        <p id="high-score-display"></p>
        <p id="score-message"></p>
        <button id="play-again" class="button">Play Again</button>
    </div>
    <script>
        // Version number
        const VERSION = "1.1.005";
        
        // Game state
        var questions = [];
        var score = 0;
        var questionCount = 0;
        var currentQuestion = null;
        var currentUser = '';
        var currentCategory = 'Science';
        var currentSubcategory = 'All';
        var currentLevel = '1';
        var usedQuestions = [];
        var settings = JSON.parse(localStorage.getItem('triviaSettings') || '{}');

        // UI elements
        var loginScreen = document.getElementById('login-screen');
        var usernameInput = document.getElementById('username');
        var loginButton = document.getElementById('login-button');
        var versionText = document.getElementById('version');
        var selectionScreen = document.getElementById('selection-screen');
        var categorySelect = document.getElementById('category');
        var subcategorySelect = document.getElementById('subcategory');
        var levelSelect = document.getElementById('level');
        var correctDurationInput = document.getElementById('correct-duration');
        var incorrectDurationInput = document.getElementById('incorrect-duration');
        var startGameButton = document.getElementById('start-game');
        var logoutButton = document.getElementById('logout-button');
        var resetStatsButton = document.getElementById('reset-stats-button');
        var userLevelText = document.getElementById('user-level');
        var userXPText = document.getElementById('user-xp');
        var categoryXPText = document.getElementById('category-xp');
        var subcategoryXPText = document.getElementById('subcategory-xp');
        var xpBarFill = document.getElementById('xp-bar-fill');
        var subcategoryXPBars = document.getElementById('subcategory-xp-bars');
        var lifeScienceXPLabel = document.getElementById('life-science-xp-label');
        var physicalScienceXPLabel = document.getElementById('physical-science-xp-label');
        var earthSpaceScienceXPLabel = document.getElementById('earth-space-science-xp-label');
        var lifeScienceXPBarFill = document.getElementById('life-science-xp-bar-fill');
        var physicalScienceXPBarFill = document.getElementById('physical-science-xp-bar-fill');
        var earthSpaceScienceXPBarFill = document.getElementById('earth-space-science-xp-bar-fill');
        var highScoresTableBody = document.getElementById('high-scores-body');
        var categoryDisplay = document.getElementById('category-display');
        var questionText = document.getElementById('question');
        var answersDiv = document.getElementById('answers');
        var feedbackText = document.getElementById('feedback');
        var gameOverDiv = document.getElementById('game-over');
        var finalScoreText = document.getElementById('final-score');
        var highScoreDisplay = document.getElementById('high-score-display');
        var scoreMessageText = document.getElementById('score-message');
        var playAgainButton = document.getElementById('play-again');

        // Set version number
        versionText.textContent = `Version ${VERSION}`;

        // Initialize data
        var highScores = JSON.parse(localStorage.getItem('triviaHighScores') || '{}');
        var userXP = JSON.parse(localStorage.getItem('triviaUserXP') || '{}');
        var categoryXP = JSON.parse(localStorage.getItem('triviaCategoryXP') || '{}');

        // Load questions from external JSON file
        fetch('./questions.json')
            .then(response => {
                if (!response.ok) {
                    throw new Error('Failed to load questions.json');
                }
                return response.json();
            })
            .then(data => {
                questions = data;
                startGameButton.disabled = false;
                startGameButton.textContent = 'Start Game';
                console.log('Questions loaded:', questions.length);
            })
            .catch(error => {
                console.error('Error loading questions:', error);
                alert('Failed to load questions. Please check if questions.json exists.');
                startGameButton.textContent = 'Failed to Load Questions';
            });

        // Shuffle array
        function shuffle(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        // Calculate user level and XP progress
        function getUserLevel(xp) {
            return Math.floor(xp / 100) + 1;
        }
        function getXPProgress(xp) {
            var level = getUserLevel(xp);
            var currentLevelXP = (level - 1) * 100;
            var nextLevelXP = level * 100;
            var progress = ((xp - currentLevelXP) / (nextLevelXP - currentLevelXP)) * 100;
            return { level, progress, currentXP: xp, nextLevelXP };
        }

        // Update subcategory dropdown and progress bars visibility
        function updateSubcategoryDropdown() {
            subcategorySelect.style.display = currentCategory === 'Science' ? 'block' : 'none';
            subcategoryXPBars.style.display = currentCategory === 'Science' ? 'block' : 'none';
            if (currentCategory !== 'Science') {
                currentSubcategory = null;
                subcategoryXPText.style.display = 'none';
            } else {
                currentSubcategory = subcategorySelect.value;
                subcategoryXPText.style.display = currentSubcategory !== 'All' ? 'block' : 'none';
            }
        }

        // Update level dropdown based on category XP
        function updateLevelDropdown() {
            var levels = [1, 2, 3, 4, 5];
            var categoryXPAmt = (categoryXP[currentUser] && categoryXP[currentUser][currentCategory]) || {};
            var totalCategoryXP = 0;
            if (currentCategory === 'Science') {
                var subcategories = ['Life Science', 'Physical Science', 'Earth and Space Science'];
                subcategories.forEach(subcat => {
                    if (categoryXPAmt[subcat]) {
                        for (var lvl in categoryXPAmt[subcat]) {
                            totalCategoryXP += categoryXPAmt[subcat][lvl] || 0;
                        }
                    }
                });
                // Include XP from 'All' (stored directly under Science for specific levels)
                for (var lvl in categoryXPAmt) {
                    if (!isNaN(lvl)) {
                        totalCategoryXP += categoryXPAmt[lvl] || 0;
                    }
                }
            } else {
                for (var lvl in categoryXPAmt) {
                    totalCategoryXP += categoryXPAmt[lvl] || 0;
                }
            }
            var xpRequirements = { 1: 0, 2: 100, 3: 300, 4: 600, 5: 1000 };
            var unlockedLevel = 1;
            if (totalCategoryXP >= 100) unlockedLevel = 2;
            if (totalCategoryXP >= 300) unlockedLevel = 3;
            if (totalCategoryXP >= 600) unlockedLevel = 4;
            if (totalCategoryXP >= 1000) unlockedLevel = 5;

            levelSelect.innerHTML = '';
            levels.forEach(level => {
                var option = document.createElement('option');
                option.value = level;
                option.textContent = `Level ${level} (${level}th Grade)`;
                if (level > unlockedLevel) option.disabled = true;
                levelSelect.appendChild(option);
            });
            levelSelect.value = Math.min(currentLevel, unlockedLevel);
        }

        // Update user stats display
        function updateUserStats() {
            var xp = userXP[currentUser] || 0;
            var { level, progress, currentXP, nextLevelXP } = getXPProgress(xp);
            userLevelText.textContent = 'Level: ' + level;
            userXPText.textContent = 'XP: ' + currentXP + ' / ' + nextLevelXP;
            var categoryXPAmt = (categoryXP[currentUser] && categoryXP[currentUser][currentCategory]) || {};
            var totalCategoryXP = 0;
            if (currentCategory === 'Science') {
                var subcategories = ['Life Science', 'Physical Science', 'Earth and Space Science'];
                subcategories.forEach(subcat => {
                    if (categoryXPAmt[subcat]) {
                        for (var lvl in categoryXPAmt[subcat]) {
                            totalCategoryXP += categoryXPAmt[subcat][lvl] || 0;
                        }
                    }
                });
                // Include XP from 'All' (stored directly under Science for specific levels)
                for (var lvl in categoryXPAmt) {
                    if (!isNaN(lvl)) {
                        totalCategoryXP += categoryXPAmt[lvl] || 0;
                    }
                }
            } else {
                for (var lvl in categoryXPAmt) {
                    totalCategoryXP += categoryXPAmt[lvl] || 0;
                }
            }
            categoryXPText.textContent = `Category XP (${currentCategory}): ` + totalCategoryXP;

            var totalSubcategoryXP = 0;
            if (currentCategory === 'Science' && currentSubcategory !== 'All') {
                var subcategoryXPAmt = (categoryXPAmt[currentSubcategory]) || {};
                for (var lvl in subcategoryXPAmt) {
                    totalSubcategoryXP += subcategoryXPAmt[lvl] || 0;
                }
                subcategoryXPText.textContent = `Subcategory XP (${currentSubcategory}): ` + totalSubcategoryXP;
                subcategoryXPText.style.display = 'block';
            } else {
                subcategoryXPText.style.display = 'none';
            }

            xpBarFill.style.width = progress + '%';

            // Update subcategory XP bars for Science
            if (currentCategory === 'Science') {
                var subcategories = ['Life Science', 'Physical Science', 'Earth and Space Science'];
                var maxXP = 1000; // Max XP for progress bar, matching Level 5 unlock threshold
                subcategories.forEach(subcat => {
                    var subcatXP = 0;
                    if (categoryXPAmt[subcat]) {
                        for (var lvl in categoryXPAmt[subcat]) {
                            subcatXP += categoryXPAmt[subcat][lvl] || 0;
                        }
                    }
                    var subcatProgress = Math.min((subcatXP / maxXP) * 100, 100);
                    if (subcat === 'Life Science') {
                        lifeScienceXPLabel.textContent = `Life Science XP: ${subcatXP}`;
                        lifeScienceXPBarFill.style.width = subcatProgress + '%';
                    } else if (subcat === 'Physical Science') {
                        physicalScienceXPLabel.textContent = `Physical Science XP: ${subcatXP}`;
                        physicalScienceXPBarFill.style.width = subcatProgress + '%';
                    } else if (subcat === 'Earth and Space Science') {
                        earthSpaceScienceXPLabel.textContent = `Earth and Space Science XP: ${subcatXP}`;
                        earthSpaceScienceXPBarFill.style.width = subcatProgress + '%';
                    }
                });
            }

            highScoresTableBody.innerHTML = '';
            if (!highScores[currentUser]) {
                highScoresTableBody.innerHTML = '<tr><td colspan="4">No scores yet!</td></tr>';
                return;
            }
            var categories = ['Science', 'Social Studies', 'English', 'Harry Potter'];
            var scienceSubcategories = ['Life Science', 'Physical Science', 'Earth and Space Science'];
            var levels = [1, 2, 3, 4, 5];
            categories.forEach(category => {
                if (category === 'Science') {
                    scienceSubcategories.forEach(subcat => {
                        levels.forEach(level => {
                            var score = (highScores[currentUser][category] && highScores[currentUser][category][subcat] && highScores[currentUser][category][subcat][level]) || 0;
                            if (score > 0) {
                                var row = document.createElement('tr');
                                row.innerHTML = `<td>${category}</td><td>${subcat}</td><td>${level}</td><td>${score}</td>`;
                                highScoresTableBody.appendChild(row);
                            }
                        });
                    });
                    // Include high scores for 'All' (stored directly under Science for specific levels)
                    levels.forEach(level => {
                        var score = (highScores[currentUser][category] && highScores[currentUser][category][level]) || 0;
                        if (score > 0) {
                            var row = document.createElement('tr');
                            row.innerHTML = `<td>${category}</td><td>All</td><td>${level}</td><td>${score}</td>`;
                            highScoresTableBody.appendChild(row);
                        }
                    });
                } else {
                    levels.forEach(level => {
                        var score = (highScores[currentUser][category] && highScores[currentUser][category][level]) || 0;
                        if (score > 0) {
                            var row = document.createElement('tr');
                            row.innerHTML = `<td>${category}</td><td>-</td><td>${level}</td><td>${score}</td>`;
                            highScoresTableBody.appendChild(row);
                        }
                    });
                }
            });
            if (highScoresTableBody.innerHTML === '') {
                highScoresTableBody.innerHTML = '<tr><td colspan="4">No scores yet!</td></tr>';
            }
        }

        // Handle login
        loginButton.onclick = function () {
            var username = usernameInput.value.trim();
            if (username === '') {
                alert('Please enter a username!');
                return;
            }
            currentUser = username;
            if (!categoryXP[currentUser]) categoryXP[currentUser] = {};
            if (!settings[currentUser]) {
                settings[currentUser] = { correctDuration: 1, incorrectDuration: 1 };
                localStorage.setItem('triviaSettings', JSON.stringify(settings));
            }
            correctDurationInput.value = settings[currentUser].correctDuration;
            incorrectDurationInput.value = settings[currentUser].incorrectDuration;
            loginScreen.style.display = 'none';
            selectionScreen.style.display = 'flex';
            updateSubcategoryDropdown();
            updateLevelDropdown();
            updateUserStats();
        };

        // Handle logout
        logoutButton.onclick = function () {
            currentUser = '';
            usernameInput.value = '';
            selectionScreen.style.display = 'none';
            loginScreen.style.display = 'flex';
        };

        // Handle reset stats
        resetStatsButton.onclick = function () {
            if (confirm('Are you sure you want to reset your XP, high scores, and settings?')) {
                delete userXP[currentUser];
                delete highScores[currentUser];
                delete categoryXP[currentUser];
                delete settings[currentUser];
                localStorage.setItem('triviaUserXP', JSON.stringify(userXP));
                localStorage.setItem('triviaHighScores', JSON.stringify(highScores));
                localStorage.setItem('triviaCategoryXP', JSON.stringify(categoryXP));
                localStorage.setItem('triviaSettings', JSON.stringify(settings));
                currentUser = '';
                usernameInput.value = '';
                selectionScreen.style.display = 'none';
                loginScreen.style.display = 'flex';
            }
        };

        // Handle category and subcategory selection
        categorySelect.addEventListener('change', function () {
            currentCategory = categorySelect.value;
            updateSubcategoryDropdown();
            updateLevelDropdown();
            updateUserStats();
        });
        subcategorySelect.addEventListener('change', function () {
            currentSubcategory = subcategorySelect.value;
            updateUserStats();
        });
        levelSelect.addEventListener('change', function () {
            currentLevel = levelSelect.value;
            updateUserStats();
        });

        // Save settings
        function saveSettings() {
            var correctDuration = parseFloat(correctDurationInput.value);
            var incorrectDuration = parseFloat(incorrectDurationInput.value);
            if (isNaN(correctDuration) || correctDuration < 0.5 || correctDuration > 10) {
                alert('Correct Response Duration must be between 0.5 and 10 seconds.');
                correctDurationInput.value = settings[currentUser].correctDuration;
                return false;
            }
            if (isNaN(incorrectDuration) || incorrectDuration < 0.5 || incorrectDuration > 10) {
                alert('Incorrect Response Duration must be between 0.5 and 10 seconds.');
                incorrectDurationInput.value = settings[currentUser].incorrectDuration;
                return false;
            }
            settings[currentUser].correctDuration = correctDuration;
            settings[currentUser].incorrectDuration = incorrectDuration;
            localStorage.setItem('triviaSettings', JSON.stringify(settings));
            return true;
        }

        correctDurationInput.addEventListener('change', saveSettings);
        incorrectDurationInput.addEventListener('change', saveSettings);

        // Start the game
        startGameButton.onclick = function () {
            if (!saveSettings()) return;
            if (questions.length === 0) {
                alert('Questions are still loading or failed to load. Please try again.');
                return;
            }
            usedQuestions = [];
            score = 0;
            questionCount = 0;
            loginScreen.style.display = 'none';
            selectionScreen.style.display = 'none';
            document.getElementById('ui').style.display = 'flex';
            categoryDisplay.style.display = 'block';
            questionText.style.display = 'block';
            answersDiv.style.display = 'block';
            feedbackText.style.display = 'block';
            loadQuestion();
        };

        // Load a new question
        function loadQuestion() {
            feedbackText.textContent = '';
            feedbackText.style.color = 'white';
            answersDiv.innerHTML = '';

            var availableQuestions = questions
                .map((q, index) => ({ question: q, index: index }))
                .filter(q => 
                    q.question.category === currentCategory &&
                    (currentCategory !== 'Science' || currentSubcategory === 'All' || q.question.subcategory === currentSubcategory) &&
                    q.question.level === parseInt(currentLevel) &&
                    !usedQuestions.includes(q.index)
                );

            if (availableQuestions.length === 0) {
                if (questionCount === 0) {
                    alert('No questions available for this category, subcategory, and level!');
                    loginScreen.style.display = 'flex';
                    document.getElementById('ui').style.display = 'none';
                    return;
                } else {
                    showGameOver();
                    return;
                }
            }

            var selected = availableQuestions[Math.floor(Math.random() * availableQuestions.length)];
            currentQuestion = selected.question;
            usedQuestions.push(selected.index);

            // Set category display to reflect the question's specific subcategory
            categoryDisplay.textContent = currentCategory + ': ' + (currentCategory === 'Science' ? currentQuestion.subcategory : '-');

            var answersWithIndices = currentQuestion.answers.map((answer, index) => ({ answer, index }));
            shuffle(answersWithIndices);
            var shuffledAnswers = answersWithIndices.map(item => item.answer);
            var newCorrectIndex = answersWithIndices.findIndex(item => item.index === currentQuestion.correct);

            questionText.textContent = currentQuestion.question;
            shuffledAnswers.forEach((answer, index) => {
                var button = document.createElement('button');
                button.textContent = answer;
                button.className = 'button';
                button.onclick = () => checkAnswer(index, newCorrectIndex);
                answersDiv.appendChild(button);
            });
        }

        // Check the answer
        function checkAnswer(index, correctIndex) {
            questionCount++;
            var levelNum = parseInt(currentLevel);
            var xpEarned = (index === correctIndex) ? 5 * levelNum : 1 * levelNum;
            userXP[currentUser] = (userXP[currentUser] || 0) + xpEarned;
            if (!categoryXP[currentUser]) categoryXP[currentUser] = {};
            if (!categoryXP[currentUser][currentCategory]) categoryXP[currentUser][currentCategory] = {};

            // Always update total category XP for the current level
            categoryXP[currentUser][currentCategory][currentLevel] = (categoryXP[currentUser][currentCategory][currentLevel] || 0) + xpEarned;

            // Update subcategory XP for Science, always using the question's subcategory
            if (currentCategory === 'Science') {
                var questionSubcategory = currentQuestion.subcategory;
                if (!categoryXP[currentUser][currentCategory][questionSubcategory]) {
                    categoryXP[currentUser][currentCategory][questionSubcategory] = {};
                }
                categoryXP[currentUser][currentCategory][questionSubcategory][currentLevel] = 
                    (categoryXP[currentUser][currentCategory][questionSubcategory][currentLevel] || 0) + xpEarned;
            }

            localStorage.setItem('triviaUserXP', JSON.stringify(userXP));
            localStorage.setItem('triviaCategoryXP', JSON.stringify(categoryXP));

            var duration = (index === correctIndex) ? settings[currentUser].correctDuration * 1000 : settings[currentUser].incorrectDuration * 1000;
            if (index === correctIndex) {
                score += 10;
                feedbackText.textContent = 'Correct!';
                feedbackText.style.color = 'white';
            } else {
                feedbackText.textContent = currentQuestion.explanation;
                feedbackText.style.color = 'red';
            }

            if (questionCount >= (currentCategory === 'Science' ? 10 : 5)) {
                showGameOver();
            } else {
                setTimeout(loadQuestion, duration);
            }
        }

        // Show game-over screen
        function showGameOver() {
            if (!highScores[currentUser]) highScores[currentUser] = {};
            if (!highScores[currentUser][currentCategory]) highScores[currentUser][currentCategory] = {};
            var highScore;
            if (currentCategory === 'Science' && currentSubcategory !== 'All') {
                if (!highScores[currentUser][currentCategory][currentSubcategory]) highScores[currentUser][currentCategory][currentSubcategory] = {};
                highScore = highScores[currentUser][currentCategory][currentSubcategory][currentLevel] || 0;
                if (score > highScore) {
                    highScores[currentUser][currentCategory][currentSubcategory][currentLevel] = score;
                    localStorage.setItem('triviaHighScores', JSON.stringify(highScores));
                }
            } else {
                highScore = highScores[currentUser][currentCategory][currentLevel] || 0;
                if (score > highScore) {
                    highScores[currentUser][currentCategory][currentLevel] = score;
                    localStorage.setItem('triviaHighScores', JSON.stringify(highScores));
                }
            }
            document.getElementById('ui').style.display = 'none';
            gameOverDiv.style.display = 'flex';
            finalScoreText.textContent = 'Final Score: ' + score;
            highScoreDisplay.textContent = 'High Score: ' + highScore;
            scoreMessageText.textContent = score > highScore ? 'New High Score!' : 'Try to beat your high score!';
            updateUserStats();
        }

        // Play again
        playAgainButton.onclick = function () {
            gameOverDiv.style.display = 'none';
            selectionScreen.style.display = 'flex';
            updateLevelDropdown();
            updateUserStats();
        };
    </script>
</body>
</html>
